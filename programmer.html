<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ESP32-C3 Web Flasher</title>
</head>
<body>
  <h1>Flasher ESP32-C3 depuis le navigateur</h1>
  
  <input type="file" id="firmware" />
  <button id="connect">Connecter et flasher</button>
  
  <pre id="log"></pre>

  <!-- Import esptool-js depuis un CDN -->
  <script src="https://unpkg.com/esptool-js@latest/dist/web/index.min.js"></script>
  <script>
    const log = document.getElementById("log");

    async function flash() {
      try {
        // Demande au navigateur d’ouvrir le port série
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        const esploader = new EspLoader(port, { log: (msg) => log.textContent += msg + "\n" });
        await esploader.initialize();

        log.textContent += "Connexion OK\n";

        // Récupère le fichier choisi
        const fileInput = document.getElementById("firmware");
        const file = fileInput.files[0];
        if (!file) {
          log.textContent += "⚠️ Aucun fichier sélectionné\n";
          return;
        }

        const arrayBuffer = await file.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);

        // Flash à l’adresse 0x0 (merged.bin)
        await esploader.writeFlash([[0x0, data]]);
        log.textContent += "✅ Flash terminé !\n";

        await port.close();
      } catch (err) {
        log.textContent += "Erreur: " + err + "\n";
      }
    }

    document.getElementById("connect").addEventListener("click", flash);
  </script>
</body>
</html>
