<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ContrÃ´le SystÃ¨me â€” Commandes SÃ©rie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 20px;
    }
    h1 { text-align: center; margin-bottom: 25px; }

    .card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .card h2 { margin-top: 0; font-size: 20px; }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    button {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
      background: #e3e7ee;
    }
    button:hover { background: #cfd6e4; }

    .cmd-btn { font-weight: bold; }

    #log {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .input-row input {
      padding: 6px 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      width: 100px;
    }
  </style>
</head>
<body>

<h1>ContrÃ´le des Ã‰tats & DÃ©fauts â€” SystÃ¨me SÃ©rie</h1>

<!-- Bouton connexion principal -->
<div style="text-align:center; margin-bottom:20px;">
  <button id="connectBtn" style="padding:14px 22px; font-size:18px; border-radius:12px; background:#4caf50; color:white;">ğŸ”Œ Connexion au port COM</button>
  <button id="versionBtn" style="padding:14px 22px; font-size:18px; border-radius:12px; background:#2196f3; color:white; margin-left:10px;">â„¹ï¸ Version (?)</button>
</div>

<!-- Ã‰tats systÃ¨me -->
<div class="card">
  <h2>Ã‰tats du systÃ¨me</h2>
  <div class="button-grid">
    <button class="cmd-btn" onclick="sendCommand('SYS_IDLE')">âšª Blanc respiration<br>SYS_IDLE</button>
    <button class="cmd-btn" onclick="sendCommand('SYS_STARTING')">âšª Blanc clignotement 1 Hz<br>SYS_STARTING</button>
    <button class="cmd-btn" onclick="sendCommand('SYS_OK')">ğŸŸ  Orange fixe<br>SYS_OK</button>
  </div>
</div>

<!-- DÃ©fauts systÃ¨me -->
<div class="card">
  <h2>Gestion des dÃ©fauts</h2>
  <div class="button-grid">
    <button class="cmd-btn" onclick="sendCommand('ERR_NET')">ğŸŸ¡ Perte Internet<br>ERR_NET</button>
    <button class="cmd-btn" onclick="sendCommand('ERR_CAM')">ğŸŸ¡ CamÃ©ra dÃ©connectÃ©e<br>ERR_CAM</button>
    <button class="cmd-btn" onclick="sendCommand('ERR_DISK')">ğŸŸ¡ ProblÃ¨me disque<br>ERR_DISK</button>
    <button class="cmd-btn" onclick="sendCommand('ERR_VMS')">ğŸŸ¡ Serveur crashÃ©<br>ERR_VMS</button>
  </div>
</div>

<!-- SECTION CUSTOM -->
<div class="card">
  <h2>LED personnalisÃ©e (RGB / Hz / Pause)</h2>

  <div class="input-row">
    <input type="number" id="rVal" min="0" max="255" placeholder="Rouge (0-255)">
    <input type="number" id="gVal" min="0" max="255" placeholder="Vert (0-255)">
    <input type="number" id="bVal" min="0" max="255" placeholder="Bleu (0-255)">
  </div>

  <div class="input-row">
    <input type="number" id="freqVal" min="0" step="0.1" placeholder="FrÃ©quence (Hz)">
    <input type="number" id="pauseVal" min="0" step="0.1" placeholder="Pause (s)">
  </div>

  <button style="margin-top:15px;" onclick="sendCustom()">ğŸ¨ Envoyer LED personnalisÃ©e</button>
</div>

<!-- Journal -->
<div class="card">
  <h2>Journal</h2>
  <div id="log"></div>
</div>

<script>
  let port;
  let writer;
  let reader;

  function log(msg) {
    const logBox = document.getElementById('log');
    logBox.innerHTML += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  async function readLoop() {
    while (port && port.readable) {
      reader = port.readable.getReader();
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            const text = new TextDecoder().decode(value).trim();
            if (text) log("â¬…ï¸ " + text);
          }
        }
      } catch (e) {
        log("âŒ Erreur lecture: " + e);
      } finally {
        try { reader.releaseLock(); } catch(e) {}
      }
    }
  }

  async function sendCommand(cmd) {
    if (!writer) {
      log("âš ï¸ Connectez d'abord un port COM");
      return;
    }
    log("â¡ï¸ " + cmd);
    try {
      await writer.write(new TextEncoder().encode(cmd + "\r\n"));
    } catch (e) {
      log("âŒ Erreur Ã©criture: " + e);
    }
  }

  function sendCustom() {
    const r = document.getElementById('rVal').value || 0;
    const g = document.getElementById('gVal').value || 0;
    const b = document.getElementById('bVal').value || 0;
    const freq = document.getElementById('freqVal').value || 0;
    const pause = document.getElementById('pauseVal').value || 0;

    const cmd = `custom;${r},${g},${b};${freq};${pause}`;
    sendCommand(cmd);
  }

  document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      writer = port.writable.getWriter();
      log("âœ… Port ouvert (9600 baud)");
      readLoop();
    } catch (err) {
      log("âŒ Erreur ouverture port: " + err);
    }
  });

  document.getElementById('versionBtn').addEventListener('click', () => {
    sendCommand('?');
  });
</script>

</body>
</html>
