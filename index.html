<script>
/* Remplace l'ancien script par celui-ci */
let port = null;
let writer = null;

const logBox = document.getElementById('log');
function log(msg){
  const t = new Date().toLocaleTimeString();
  logBox.textContent = `${t}  ${msg}\n` + logBox.textContent;
  console.log(msg);
}

// Vérifie la disponibilité de l'API
if(!('serial' in navigator)){
  log('Web Serial API NON disponible dans ce navigateur (ou contexte non sécurisé).');
}

// Rafraîchit la liste des ports accessibles
async function refreshPorts(){
  try{
    const sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- Aucun --</option>';
    const ports = await navigator.serial.getPorts();
    ports.forEach((p, idx) => {
      const opt = document.createElement('option');
      let info = {};
      try { info = p.getInfo ? p.getInfo() : {}; } catch(e){}
      const labelParts = [];
      if(info.usbVendorId) labelParts.push('VID:'+info.usbVendorId.toString(16));
      if(info.usbProductId) labelParts.push('PID:'+info.usbProductId.toString(16));
      opt.value = idx;
      opt.textContent = labelParts.length ? `Port ${idx+1} (${labelParts.join(' ')})` : `Port ${idx+1}`;
      opt._port = p;
      sel.appendChild(opt);
    });
    log(`Liste des ports mise à jour (${ports.length} trouvés).`);
  }catch(e){
    log('Erreur refreshPorts: ' + e);
  }
}

// Bouton : demande à l'utilisateur de choisir un port.
// IMPORTANT : requestPort doit être appelé depuis un événement utilisateur (clic).
document.getElementById('requestBtn').addEventListener('click', async () => {
  try{
    if(!('serial' in navigator)){
      log('Impossible : Web Serial API non disponible.');
      return;
    }
    // L'appel requestPort ouvre la boîte de dialogue de sélection
    const chosenPort = await navigator.serial.requestPort();
    log('Port sélectionné (dialogue ok).');
    await refreshPorts();
    // sélection automatique du dernier port ajouté
    const sel = document.getElementById('portSelect');
    sel.selectedIndex = sel.options.length - 1;
  }catch(e){
    // L'utilisateur peut annuler — on l'indique proprement
    if(e.name === 'NotFoundError' || e.name === 'DOMException'){
      log('Sélection annulée ou aucun périphérique choisi.');
    } else {
      log('Erreur requestPort: ' + e);
    }
  }
});

// Connecter au port sélectionné
document.getElementById('connectBtn').addEventListener('click', async () => {
  try{
    const sel = document.getElementById('portSelect');
    if(sel.selectedIndex <= 0){
      log('Aucun port sélectionné.');
      return;
    }
    const opt = sel.options[sel.selectedIndex];
    const p = opt._port;
    const baud = parseInt(document.getElementById('baudSelect').value, 10);
    await p.open({ baudRate: baud });
    port = p;
    writer = port.writable.getWriter();
    log(`Connecté au port (baud ${baud}).`);
    readLoop(port);
  }catch(e){
    log('Erreur connexion: ' + e);
  }
});

document.getElementById('closeBtn').addEventListener('click', async () => {
  try{
    if(writer){ await writer.close(); writer = null; }
    if(port){ await port.close(); port = null; }
    log('Port fermé.');
  }catch(e){ log('Erreur fermeture: ' + e); }
});

async function sendCmd(cmd){
  if(!writer){ log(`Non connecté — impossible d'envoyer: ${cmd}`); return; }
  try{
    await writer.write(new TextEncoder().encode(cmd + '\n'));
    log('→ ' + cmd);
  }catch(e){ log('Erreur envoi: ' + e); }
}

// Lecture simple (affiche toute donnée reçue)
async function readLoop(p){
  try{
    while(p.readable){
      const reader = p.readable.getReader();
      try{
        while(true){
          const { value, done } = await reader.read();
          if(done) break;
          if(value){
            const text = new TextDecoder().decode(value);
            log('← ' + text.trim());
          }
        }
      } finally {
        reader.releaseLock();
      }
      break; // on sort pour éviter double boucle (gestion simple)
    }
  }catch(e){
    log('Erreur lecture: ' + e);
  }
}

// Initialisation : tente de lister les ports déjà autorisés
window.addEventListener('load', () => {
  if('serial' in navigator){
    refreshPorts();
    log('API Web Serial détectée. Cliquez sur "Choisir un port..." pour sélectionner un périphérique.');
  } else {
    log('Web Serial API non détectée.');
  }
});
</script>
