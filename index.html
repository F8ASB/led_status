<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ContrÃ´le SystÃ¨me â€” Commandes SÃ©rie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
    }

    /* Cartes modernes */
    .card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    .card h2 {
      margin-top: 0;
      font-size: 20px;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    button {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
      background: #e3e7ee;
    }
    button:hover {
      background: #cfd6e4;
    }

    .cmd-btn {
      font-weight: bold;
    }

    #log {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h1>ContrÃ´le des Ã‰tats & DÃ©fauts â€” SystÃ¨me SÃ©rie</h1>

<!-- Bloc Port COM -->
<div class="card">
  <h2>Connexion</h2>
  <button id="connectBtn">ğŸ”Œ Choisir un port COM</button>
  <button id="versionBtn">â„¹ï¸ Version (?)</button>
</div>

<!-- Ã‰tats systÃ¨me -->
<div class="card">
  <h2>Ã‰tats du systÃ¨me</h2>
  <div class="button-grid">
    <button class="cmd-btn" onclick="sendCommand('SYS_IDLE')">âšª Blanc respiration<br>SYS_IDLE</button>
    <button class="cmd-btn" onclick="sendCommand('SYS_STARTING')">âšª Blanc clignotement 1 Hz<br>SYS_STARTING</button>
    <button class="cmd-btn" onclick="sendCommand('SYS_OK')">ğŸŸ  Orange fixe<br>SYS_OK</button>
  </div>
</div>

<!-- DÃ©fauts systÃ¨me -->
<div class="card">
  <h2>Gestion des dÃ©fauts</h2>
  <div class="button-grid">
    <button class="cmd-btn" onclick="sendCommand('ERR_NET')">ğŸŸ¡ Perte Internet<br>ERR_NET</button>
    <button class="cmd-btn" onclick="sendCommand('ERR_CAM')">ğŸŸ¡ CamÃ©ra dÃ©connectÃ©e<br>ERR_CAM</button>
    <button class="cmd-btn" onclick="sendCommand('ERR_DISK')">ğŸŸ¡ ProblÃ¨me disque<br>ERR_DISK</button>
    <button class="cmd-btn" onclick="sendCommand('ERR_VMS')">ğŸŸ¡ Serveur crashÃ©<br>ERR_VMS</button>
  </div>
</div>

<!-- Journal -->
<div class="card">
  <h2>Journal</h2>
  <div id="log"></div>
</div>

<script>
  let port;
  let writer;
  let reader;

  function log(msg) {
    const logBox = document.getElementById('log');
    logBox.innerHTML += msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
  }

  async function readLoop() {
    while (port && port.readable) {
      reader = port.readable.getReader();
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            const text = new TextDecoder().decode(value).trim();
            if (text) log("â¬…ï¸ " + text);
          }
        }
      } catch (e) {
        log("âŒ Erreur lecture: " + e);
      } finally {
        try { reader.releaseLock(); } catch(e) {}
      }
    }
  }

  async function sendCommand(cmd) {
    if (!writer) {
      log("âš ï¸ Connectez d'abord un port COM");
      return;
    }
    log("â¡ï¸ " + cmd);
    try {
      await writer.write(new TextEncoder().encode(cmd + "\r\n"));
    } catch (e) {
      log("âŒ Erreur Ã©criture: " + e);
    }
  }

  document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      writer = port.writable.getWriter();
      log("âœ… Port ouvert (9600 baud)");
      readLoop();
    } catch (err) {
      log("âŒ Erreur ouverture port: " + err);
    }
  });

  document.getElementById('versionBtn').addEventListener('click', () => {
    sendCommand('?');
  });
</script>

</body>
</html>
